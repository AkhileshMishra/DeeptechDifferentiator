# Requirements Document

## Introduction

This feature adds OHIF Viewer integration to properly render HTJ2K/JP2 medical images from AWS HealthImaging. The current frontend cannot decode these formats natively, so we route them to OHIF which has proper codec support.

## Glossary

- **OHIF_Viewer**: Open Health Imaging Foundation viewer - open-source medical image viewer with HTJ2K codec support
- **HTJ2K**: High-Throughput JPEG 2000 - the transfer syntax used by AWS HealthImaging
- **Transfer_Syntax**: DICOM encoding format identifier (e.g., HTJ2K, JPEG, uncompressed)
- **Resolve_Viewer_Lambda**: Lambda function that determines which viewer to use based on image format
- **Frontend_Router**: Client-side logic that redirects to appropriate viewer

## Requirements

### Requirement 1: Viewer Resolution

**User Story:** As a user, I want the system to automatically route me to the correct viewer, so that I can see medical images regardless of their encoding format.

#### Acceptance Criteria

1. WHEN a user requests to view an image set, THE Resolve_Viewer_Lambda SHALL check the transfer syntax from HealthImaging metadata
2. WHEN the transfer syntax is HTJ2K or JP2, THE Resolve_Viewer_Lambda SHALL return viewer type "ohif" with a launch URL
3. WHEN the transfer syntax is JPEG or PNG, THE Resolve_Viewer_Lambda SHALL return viewer type "native"
4. IF the metadata retrieval fails, THEN THE Resolve_Viewer_Lambda SHALL return an error with descriptive message

### Requirement 2: Frontend Routing

**User Story:** As a user, I want seamless navigation to the appropriate viewer, so that I don't have to manually choose how to view images.

#### Acceptance Criteria

1. WHEN the Frontend_Router receives viewer type "ohif", THE Frontend_Router SHALL redirect to the OHIF launch URL
2. WHEN the Frontend_Router receives viewer type "native", THE Frontend_Router SHALL render using existing JPEG/PNG display logic
3. WHEN redirecting to OHIF, THE Frontend_Router SHALL use same-tab navigation to avoid popup blockers

### Requirement 3: Seamless User Experience

**User Story:** As a user, I want a consistent viewing experience regardless of image format, so that I don't notice when format switching occurs.

#### Acceptance Criteria

1. THE Frontend_Router SHALL display a loading indicator during viewer resolution
2. THE OHIF_Viewer SHALL use consistent styling and branding with the main application
3. WHEN transitioning between viewers, THE system SHALL maintain visual continuity without jarring UI changes
4. THE OHIF_Viewer SHALL provide a "Back to Dashboard" navigation option matching the main app style
5. IF viewer resolution takes longer than 2 seconds, THEN THE Frontend_Router SHALL show a progress message

### Requirement 4: OHIF Configuration

**User Story:** As a developer, I want OHIF configured with HealthImaging adapter, so that it can stream images directly from the datastore.

#### Acceptance Criteria

1. THE OHIF_Viewer SHALL be deployed with AWS HealthImaging adapter enabled
2. THE OHIF_Viewer SHALL receive StudyInstanceUID and ImageSetID as URL parameters
3. THE OHIF_Viewer SHALL authenticate using the same Cognito identity pool as the main frontend

### Requirement 5: Infrastructure Configuration

**User Story:** As a developer, I want the OHIF URL configurable via Terraform, so that deployments are consistent across environments.

#### Acceptance Criteria

1. THE Frontend config.js SHALL include OHIF_BASE_URL generated by Terraform
2. THE API_Gateway SHALL expose a GET /resolve-viewer endpoint
3. THE Resolve_Viewer_Lambda SHALL have IAM permissions for medical-imaging:GetImageSetMetadata
