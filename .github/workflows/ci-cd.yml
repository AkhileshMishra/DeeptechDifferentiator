name: Healthcare Imaging MLOps CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

# REQUIRED: Permissions for OIDC authentication
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0
  PYTHON_VERSION: "3.11"
  # The Role ARN you specified
  IAM_ROLE_ARN: arn:aws:iam::637423443220:role/GitHubActionRole

jobs:
  # Code Quality Checks (No AWS auth needed)
 
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo docker image prune --all --force
          df -h
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dev dependencies
        run: pip install --no-cache-dir -r python/requirements-dev.txt
      
      - name: Run Black
        run: black --check python/ || true
      
      - name: Run Flake8
        run: flake8 python/ --max-line-length=120 || true
  # Unit Tests (No AWS auth needed)
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        
      
      - name: Install dependencies
        run: pip install --no-cache-dir -r python/requirements-dev.txt
      
      - name: Run tests
        run: |
          cd python
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html || true


  # Terraform Validation (No AWS auth needed)
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: terraform
      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform

  # Security Scanning (No AWS auth needed)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
    # Create ECR Repositories (NEEDS AWS AUTH)
  create-ecr-repos:
    name: Create ECR Repositories
    runs-on: ubuntu-latest
    needs: [test, terraform-validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR repositories if they don't exist
        run: |
          REPOS=("preprocessing" "training" "evaluation" "inference")
          for repo in "${REPOS[@]}"; do
            REPO_NAME="healthcare-imaging-mlops-${repo}"
            echo "Checking if repository ${REPO_NAME} exists..."
            if ! aws ecr describe-repositories --repository-names ${REPO_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null; then
              echo "Creating repository ${REPO_NAME}..."
              aws ecr create-repository \
                --repository-name ${REPO_NAME} \
                --region ${{ env.AWS_REGION }} \
                --image-scanning-configuration scanOnPush=true \
                --encryption-configuration encryptionType=AES256 \
                --tags Key=Project,Value=healthcare-imaging-mlops Key=ManagedBy,Value=github-actions
              echo "Repository ${REPO_NAME} created successfully"
            else
              echo "Repository ${REPO_NAME} already exists"
            fi
          done

  # Build Docker Images (NEEDS AWS AUTH)
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, terraform-validate, create-ecr-repos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        image: [preprocessing, training, evaluation, inference]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/sagemaker/${{ matrix.image }}/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/healthcare-imaging-mlops-${{ matrix.image }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/healthcare-imaging-mlops-${{ matrix.image }}:latest



  # Deploy to Development (NEEDS AWS AUTH)
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # UPDATED: OIDC Auth
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=healthtech/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"
        working-directory: terraform

      - name: Terraform Plan
        run: terraform plan -var-file=environments/dev.tfvars -out=tfplan
        working-directory: terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: terraform

      - name: Get Deployment Outputs
        id: outputs
        run: |
          echo "frontend_url=$(terraform output -raw frontend_url)" >> $GITHUB_OUTPUT
          echo "ohif_bucket=$(terraform output -raw ohif_viewer_bucket)" >> $GITHUB_OUTPUT
          echo "ohif_cloudfront_id=$(terraform output -raw ohif_cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          echo "ohif_url=$(terraform output -raw ohif_viewer_url)" >> $GITHUB_OUTPUT
          echo "datastore_id=$(terraform output -raw healthimaging_data_store_id)" >> $GITHUB_OUTPUT
          echo "cognito_user_pool_id=$(terraform output -raw cognito_user_pool_id)" >> $GITHUB_OUTPUT
          echo "cognito_client_id=$(terraform output -raw cognito_client_id)" >> $GITHUB_OUTPUT
          echo "cognito_identity_pool_id=$(terraform output -raw cognito_identity_pool_id)" >> $GITHUB_OUTPUT
          echo "cognito_domain=$(terraform output -raw cognito_domain)" >> $GITHUB_OUTPUT
        working-directory: terraform
        continue-on-error: true
    
    outputs:
      frontend_url: ${{ steps.outputs.outputs.frontend_url }}
      ohif_bucket: ${{ steps.outputs.outputs.ohif_bucket }}
      ohif_cloudfront_id: ${{ steps.outputs.outputs.ohif_cloudfront_id }}
      ohif_url: ${{ steps.outputs.outputs.ohif_url }}
      datastore_id: ${{ steps.outputs.outputs.datastore_id }}
      cognito_user_pool_id: ${{ steps.outputs.outputs.cognito_user_pool_id }}
      cognito_client_id: ${{ steps.outputs.outputs.cognito_client_id }}
      cognito_identity_pool_id: ${{ steps.outputs.outputs.cognito_identity_pool_id }}
      cognito_domain: ${{ steps.outputs.outputs.cognito_domain }}

  # Build and Deploy OHIF Viewer
  deploy-ohif:
    name: Deploy OHIF Viewer
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Yarn
        run: npm install -g yarn

      - name: Clone OHIF Viewer
        run: |
          # Use OHIF v3.11.0 which is tested with AWS HealthImaging
          echo "Downloading OHIF v3.11.0..."
          wget -q -O ohif.zip https://github.com/OHIF/Viewers/archive/refs/tags/v3.11.0.zip
          unzip -qq ohif.zip
          mv Viewers-3.11.0 ohif-source
          ls -la ohif-source/

      - name: Generate OHIF Configuration
        run: |
          # Create config directory
          mkdir -p ohif-source/platform/app/public/config
          
          # Apply AWS HealthImaging compatibility fix (remove Accept header)
          echo "Applying AWS HealthImaging compatibility fixes..."
          cat > ohif-source/apply-fixes.js << 'FIXEOF'
const fs = require("fs");
console.log("Applying Accept header fix...");
try {
  const asyncLoaderPath = "extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoaderAsync.js";
  if (fs.existsSync(asyncLoaderPath)) {
    let asyncContent = fs.readFileSync(asyncLoaderPath, "utf8");
    asyncContent = asyncContent.replace(/if \(seriesInstanceUID\)/, "delete client.headers.Accept;\n    if (seriesInstanceUID)");
    fs.writeFileSync(asyncLoaderPath, asyncContent);
    console.log("Applied Accept header fix to async loader");
  } else {
    console.log("File not found: " + asyncLoaderPath);
  }
} catch (error) {
  console.error("Error applying fixes:", error.message);
  process.exit(1);
}
FIXEOF
          cd ohif-source && node apply-fixes.js && cd ..
          
          # Generate OHIF config for AWS HealthImaging DICOMweb endpoint
          cat > ohif-source/platform/app/public/config/default.js << CONFIGEOF
window.config = {
  routerBasename: '/',
  extensions: [],
  modes: [],
  showStudyList: true,
  maxNumRequests: {
    interaction: 200,
    thumbnail: 100,
    prefetch: 50
  },
  dataSources: [{
    namespace: '@ohif/extension-default.dataSourcesModule.dicomweb',
    sourceName: 'dicomweb',
    configuration: {
      friendlyName: 'AWS HealthImaging',
      name: 'aws-healthimaging',
      wadoUriRoot: 'https://dicom-medical-imaging.${{ env.AWS_REGION }}.amazonaws.com/datastore/${{ needs.deploy-dev.outputs.datastore_id }}',
      qidoRoot: 'https://dicom-medical-imaging.${{ env.AWS_REGION }}.amazonaws.com/datastore/${{ needs.deploy-dev.outputs.datastore_id }}',
      wadoRoot: 'https://dicom-medical-imaging.${{ env.AWS_REGION }}.amazonaws.com/datastore/${{ needs.deploy-dev.outputs.datastore_id }}',
      acceptHeader: ['*/*'],
      qidoSupportsIncludeField: false,
      supportsReject: false,
      imageRendering: 'wadors',
      thumbnailRendering: 'wadors',
      enableStudyLazyLoad: true,
      supportsFuzzyMatching: false,
      supportsWildcard: false,
      staticWado: false,
      singlepart: 'bulkdata,video',
      requestOptions: {
        headers: {
          'Authorization': 'Bearer {{ACCESS_TOKEN}}'
        }
      }
    }
  }],
  oidc: [{
    authority: 'https://cognito-idp.${{ env.AWS_REGION }}.amazonaws.com/${{ needs.deploy-dev.outputs.cognito_user_pool_id }}',
    client_id: '${{ needs.deploy-dev.outputs.cognito_client_id }}',
    redirect_uri: '${{ needs.deploy-dev.outputs.ohif_url }}/callback',
    response_type: 'code',
    scope: 'openid profile email',
    post_logout_redirect_uri: '${{ needs.deploy-dev.outputs.ohif_url }}/logout',
    automaticSilentRenew: true,
    revokeAccessTokenOnSignout: false
  }]
};
CONFIGEOF
          
          echo "Config file created:"
          cat ohif-source/platform/app/public/config/default.js

      - name: Cache OHIF Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ohif-source/node_modules
            ohif-source/.yarn/cache
          key: ohif-deps-${{ hashFiles('ohif-source/yarn.lock') }}
          restore-keys: |
            ohif-deps-

      - name: Install OHIF Dependencies
        run: |
          cd ohif-source
          yarn install --frozen-lockfile
        timeout-minutes: 15

      - name: Build OHIF Viewer
        run: |
          cd ohif-source
          # Try different build approaches based on OHIF version
          if [ -f "yarn.lock" ]; then
            # Set config and build
            PUBLIC_URL=/ APP_CONFIG=config/healthimaging.js yarn run build || yarn build
          else
            npm run build
          fi
          
          # List what was built
          echo "Build output directories:"
          find . -type d -name "dist" | head -10
        timeout-minutes: 20
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"

      - name: Find OHIF Build Output
        id: find-dist
        run: |
          # OHIF build output location varies by version
          if [ -d "ohif-source/platform/app/dist" ]; then
            echo "dist_path=ohif-source/platform/app/dist" >> $GITHUB_OUTPUT
          elif [ -d "ohif-source/platform/viewer/dist" ]; then
            echo "dist_path=ohif-source/platform/viewer/dist" >> $GITHUB_OUTPUT
          elif [ -d "ohif-source/dist" ]; then
            echo "dist_path=ohif-source/dist" >> $GITHUB_OUTPUT
          else
            echo "Looking for dist directory..."
            find ohif-source -type d -name "dist" | head -5
            # Use the first dist directory found under platform
            DIST_PATH=$(find ohif-source/platform -type d -name "dist" -print -quit 2>/dev/null || echo "")
            if [ -n "$DIST_PATH" ]; then
              echo "dist_path=$DIST_PATH" >> $GITHUB_OUTPUT
            else
              echo "Error: Could not find OHIF dist directory"
              exit 1
            fi
          fi
          echo "Using dist path: $(cat $GITHUB_OUTPUT | grep dist_path)"

      - name: Deploy OHIF to S3
        run: |
          aws s3 sync ${{ steps.find-dist.outputs.dist_path }}/ s3://${{ needs.deploy-dev.outputs.ohif_bucket }}/ --delete

      - name: Invalidate OHIF CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-dev.outputs.ohif_cloudfront_id }} \
            --paths "/*"

      - name: Print Deployment Summary
        run: |
          echo "=========================================="
          echo "üè• OHIF Viewer Deployed!"
          echo "=========================================="
          echo "Frontend URL: ${{ needs.deploy-dev.outputs.frontend_url }}"
          echo "OHIF Viewer URL: ${{ needs.deploy-dev.outputs.ohif_url }}"
          echo "HealthImaging Datastore: ${{ needs.deploy-dev.outputs.datastore_id }}"
          echo "=========================================="

  # Deploy to Production (NEEDS AWS AUTH)
  #deploy-prod:
   # name: Deploy to Production
    #runs-on: ubuntu-latest
    #needs: deploy-dev
    #if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #environment: production
    #steps:
     # - name: Checkout code
      #  uses: actions/checkout@v4

      # UPDATED: OIDC Auth
     # - name: Configure AWS credentials
      #  uses: aws-actions/configure-aws-credentials@v4
       # with:
        #  role-to-assume: ${{ env.IAM_ROLE_ARN }}
         # aws-region: ${{ env.AWS_REGION }}

  #    - name: Setup Terraform
   #     uses: hashicorp/setup-terraform@v3
    #    with:
     #     terraform_version: ${{ env.TF_VERSION }}
#
 #     - name: Terraform Init
  #      run: terraform init
   #     working-directory: terraform

    #  - name: Terraform Plan
     #   run: terraform plan -var-file=environments/prod.tfvars -out=tfplan
      #  working-directory: terraform

  #    - name: Terraform Apply
   #     run: terraform apply -auto-approve tfplan
    #    working-directory: terraform

   #   - name: Validate Deployment
    #    run: ./scripts/validate-deployment.sh
